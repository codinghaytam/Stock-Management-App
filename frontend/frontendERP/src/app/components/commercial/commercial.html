<div class="commercial-page">
  <div class="page-header">
    <div>
      <h2>Assemblage & conditionnement</h2>
      <p>Coordonnez la création de bouteilles et l&apos;assemblage des boites en orchestrant vos stocks disponibles.</p>
    </div>
    <div class="header-actions">
      <button type="button" class="btn-outline" (click)="refreshBottles()">
        <span class="material-symbols-outlined">refresh</span>
        Rafraîchir
      </button>
      <button type="button" class="btn-primary" (click)="createBox()" [disabled]="!isValidSelection || loading">
        <span class="material-symbols-outlined">inventory_2</span>
        Assembler la boite
      </button>
    </div>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-icon">
        <span class="material-symbols-outlined">inventory</span>
      </div>
      <p class="kpi-label">Bouteilles disponibles</p>
      <div class="kpi-value">
        <h3>{{ availableBottleCount | number }}</h3>
        <span class="kpi-badge">{{ activeTypesCount }} types actifs</span>
      </div>
      <p class="kpi-note">Stock prêt pour l&apos;assemblage</p>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">
        <span class="material-symbols-outlined">select_check_box</span>
      </div>
      <p class="kpi-label">Sélection en cours</p>
      <div class="kpi-value">
        <h3>{{ selectionProgress.current }} / {{ selectionProgress.target }}</h3>
        <span class="kpi-badge" [class.ready]="selectionProgress.current === selectionProgress.target">{{ selectionProgress.status }}</span>
      </div>
      <p class="kpi-note">Cible par boite</p>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon">
        <span class="material-symbols-outlined">sell</span>
      </div>
      <p class="kpi-label">Prix moyen</p>
      <div class="kpi-value">
        <h3>{{ averageBottlePrice | number:'1.0-2' }} DZD</h3>
        <span class="kpi-badge neutral">Actualisé</span>
      </div>
      <p class="kpi-note">Données commerciales</p>
    </div>
  </div>

  <div *ngIf="successMessage" class="alert success">
    <span class="material-symbols-outlined">check_circle</span>
    <div>
      <h3>Opération réussie</h3>
      <p>{{ successMessage }}</p>
    </div>
  </div>
  <div *ngIf="errorMessage" class="alert error">
    <span class="material-symbols-outlined">error</span>
    <div>
      <h3>Action impossible</h3>
      <p>{{ errorMessage }}</p>
    </div>
  </div>

  <div class="table-card">
    <div class="table-header">
      <div>
        <h4>Bouteilles disponibles</h4>
        <p>Inventaire des bouteilles prêtes pour l&apos;assemblage</p>
      </div>
      <div class="table-actions">
        <button type="button" class="btn-outline" (click)="refreshBottles()">
          <span class="material-symbols-outlined">filter_list</span>
          Filtrer
        </button>
        <button type="button" class="btn-primary" (click)="createBox()" [disabled]="!isValidSelection || loading">
          <span class="material-symbols-outlined">add</span>
          Nouvelle boite
        </button>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th></th>
            <th>ID</th>
            <th>Type</th>
            <th>Volume</th>
            <th>Prix</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let b of availableBottles" [class.selected]="selectedBottles.has(b.id!)" (click)="toggleBottleSelection(b.id!)">
            <td>
              <span class="checkbox" [class.checked]="selectedBottles.has(b.id!)">
                <span class="material-symbols-outlined">check</span>
              </span>
            </td>
            <td>#{{ b.id }}</td>
            <td><span class="badge">{{ b.type }}</span></td>
            <td>{{ b.litrage }}L</td>
            <td>{{ b.prix | number:'1.0-0' }}</td>
          </tr>
          <tr *ngIf="availableBottles.length === 0">
            <td colspan="5" class="empty">Aucune bouteille disponible pour l&apos;instant.</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="table-footer">
      <span>Showing {{ availableBottleCount }} bottles</span>
      <div class="pager">
        <button type="button">Previous</button>
        <button type="button">Next</button>
      </div>
    </div>
  </div>

  <div class="grid">
    <article class="card">
      <header>
        <div>
          <p class="eyebrow">Production directe</p>
          <h3>Enregistrer une bouteille</h3>
          <p>Déclarez une nouvelle bouteille commercialisable en sélectionnant type, litrage et prix de vente.</p>
        </div>
      </header>
      <form (ngSubmit)="createBottle()" #bottleFormRef="ngForm">
        <div class="form-grid">
          <label class="input-group">
            <span>Type</span>
            <div class="select-wrapper">
              <select name="type" [(ngModel)]="bottleForm.type" required>
                <option *ngFor="let t of types" [value]="t">{{ t }}</option>
              </select>
              <span class="material-symbols-outlined">arrow_drop_down</span>
            </div>
          </label>
          <label class="input-group">
            <span>Litrage</span>
            <div class="select-wrapper">
              <select name="litrage" [(ngModel)]="bottleForm.litrage" required>
                <option *ngFor="let l of litrages" [value]="l">{{ l }}L</option>
              </select>
              <span class="material-symbols-outlined">arrow_drop_down</span>
            </div>
          </label>
          <label class="input-group">
            <span>Prix (DZD)</span>
            <input type="number" name="prix" [(ngModel)]="bottleForm.prix" required min="0" step="0.5">
          </label>
        </div>
        <footer class="actions">
          <button type="submit" [disabled]="!bottleFormRef.valid || loading" class="btn-primary">
            <span *ngIf="!loading" class="btn-label">
              <span class="material-symbols-outlined">add_circle</span>
              Créer la bouteille
            </span>
            <span *ngIf="loading" class="spinner"></span>
          </button>
          <p class="helper">Les bouteilles enregistrées sont immédiatement disponibles pour l&apos;assemblage en boites.</p>
        </footer>
      </form>
    </article>

    <article class="card">
      <header>
        <div>
          <p class="eyebrow">Assemblage</p>
          <h3>Configurer la boite</h3>
          <p>Sélectionnez les bouteilles prêtes pour assembler la boite au format adapté.</p>
        </div>
        <span class="pill">{{ boxForm.litrage }}L</span>
      </header>
      <div class="form-grid compact">
        <label class="input-group">
          <span>Capacité cible</span>
          <div class="select-wrapper">
            <select [(ngModel)]="boxForm.litrage">
              <option *ngFor="let l of litrages" [value]="l">{{ l }}L · {{ l === 1 ? 15 : l === 0.5 ? 30 : l === 2 ? 8 : 6 }} bouteilles</option>
            </select>
            <span class="material-symbols-outlined">arrow_drop_down</span>
          </div>
        </label>
        <label class="input-group">
          <span>Prix de vente</span>
          <input type="number" [(ngModel)]="boxForm.prix" min="0" step="1">
        </label>
      </div>
      <section class="selection-progress">
        <div class="progress-bar">
          <div class="fill" [style.width.%]="selectionProgress.ratio * 100"></div>
        </div>
        <div class="progress-details">
          <span>{{ selectionProgress.current }} / {{ selectionProgress.target }} bouteilles sélectionnées</span>
          <span class="status" [class.ready]="selectionProgress.current === selectionProgress.target">{{ selectionProgress.status }}</span>
        </div>
      </section>
      <footer class="actions">
        <button type="button" (click)="createBox()" [disabled]="!isValidSelection || loading" class="btn-primary">
          <span *ngIf="!loading" class="btn-label">
            <span class="material-symbols-outlined">inventory_2</span>
            Assembler la boite
          </span>
          <span *ngIf="loading" class="spinner"></span>
        </button>
        <p class="helper">Tous les éléments sélectionnés doivent partager le même type et litrage.</p>
      </footer>
    </article>
  </div>
</div>
